---
title: "Supplementary Material: Data Analysis"
author: "Matthew Lincoln"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Supplementary Material: Data Analysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r libraries, echo=FALSE, warnings = FALSE, message = FALSE, tidy = TRUE}
knitr::opts_chunk$set(warnings = FALSE, message = FALSE, fig.width = 7, fig.height = 5)
library(londonauctions)
library(tidyr)
library(dplyr)
library(ggplot2)
library(broom)
```

Code for generating Figure 1.

```{r per_year}
ggplot(sales, aes(x = year, fill = !is.na(transaction_amt))) +
  geom_histogram(binwidth = 1, alpha = 0.7) +
  theme_bw() +
  scale_fill_brewer(type = "qual", palette = 6) +
  theme(legend.position = "bottom") +
  labs(x = "Year", y = "Painting lots auctioned per year", fill = "has transaction price?")
```

Code for generating Figure 2.

```{r per_month}
month_names <- c("January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December")
ggplot(sales %>% mutate(month = factor(month, labels = month_names)), aes(x = month, fill = !is.na(transaction_amt))) +
  theme_bw() +
  geom_histogram(alpha = 0.7) +
  scale_fill_brewer(type = "qual", palette = 6) +
  theme(legend.position = "bottom") +
  labs(x = "Year", y = "Paintings auctioned per month", fill = "has transaction price?")
```

We are interested in measuring how temporally-concentrated sales were in a given
year. Simply plotting out the number of sales on each day for a number of years
within our period of study suggests that auctioneers in later years increasingly
concentrated their sales within a shorter period.

```{r example_years}
sales %>% 
  filter(year %in% seq(1800, 1830, 10), price_factor == 5) %>% 
  count(year, yday) %>% 
  ggplot(aes(x = yday, y = n)) +
  geom_bar(stat = "identity") +
  facet_wrap(~ year, ncol = 1) +
  theme_bw() +
  labs(x = "Day of the year", y = "Number of sales")
```

To focus our analysis on the spread of the most successful sales for each year,
we look for the top $n$ sale days for each year and calculate their _coefficient
of variation_. For example, the top sale days (counted by number of lots sold)
for 1790 would look like so:

```{r example_top}
top_examples <- sales %>% 
  filter(year %in% seq(1800, 1830, 10), price_factor == 5) %>% 
  count(year, yday) %>% 
  mutate(
    rank = row_number(desc(n)),
    is_top = rank <= 7)
  
ggplot(top_examples, aes(x = yday, y = n, fill = is_top)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = c("black", "red")) +
  facet_wrap(~ year, ncol = 1) +
  theme_bw() +
  theme(legend.position = "none") +
  labs(x = "Day of the year", y = "Number of sales")
```

The seven top sales days for each year are marked in red. From these example 
years, we see that the top-most days become increasingly concentratee cgetween 
1790 and 1830. The coefficient of variation (the standard deviation of each day 
by the mean of all days) confirms this visual impression. Years with more 
concentrated top sales days have a lower coefficient of variation; their top 
sales days are simply closer to eachother in the calendar year.

```{r, results='asis'}
cv_examples <- top_examples %>% 
  filter(is_top == TRUE) %>% 
  group_by(year) %>% 
  summarize(cv = sd(yday)/mean(yday))

knitr::kable(cv_examples, digits = 3)
```



```{r top_n}
# What number of top days will be considered in the calculation of seasonal
# spread?
n_days <- 7

# Calculate count, total, and average for every day of every year, grouped by
# price_factor
peaks <- sales %>%
  # Only consider records that have price information
  filter(!(is.na(price_factor))) %>%
  group_by(year, yday, price_factor) %>%
  summarize(
    daily_count = n(),
    daily_sum = sum(transaction_amt),
    daily_avg = daily_sum/daily_count
  )

# Find the top-N days in terms of daily_count, daily_sum, and daily_avg
peak_n <- peaks %>%
  group_by(year, price_factor) %>%
  filter(row_number(desc(daily_count)) <= n_days) %>%
  select(year, price_factor, count_day = yday) %>% 
  ungroup()

peak_sum <- peaks %>%
  group_by(year, price_factor) %>%
  filter(row_number(desc(daily_sum)) <= n_days) %>%
  select(year, price_factor, sum_day = yday) %>% 
  ungroup()

peak_avg <- peaks %>%
  group_by(year, price_factor) %>%
  filter(row_number(desc(daily_avg)) <= n_days) %>%
  select(year, price_factor, avg_day = yday) %>% 
  ungroup()
```



```{r changing_cv}
# Calculate the coefficient of variation of the top-N days for each year and price
# factor - i.e. how spread apart through the year are they? Combine into one
# table for easy plotting and analysis
all_peaks <- peak_n %>% group_by(year, price_factor) %>% summarize(count_cv = sd(count_day)/mean(count_day)) %>%
  left_join(peak_sum %>% group_by(year, price_factor) %>% summarize(sum_cv = sd(sum_day)/mean(sum_day)), by = c("year", "price_factor")) %>%
  left_join(peak_avg %>% group_by(year, price_factor) %>% summarize(avg_cv = sd(avg_day)/mean(avg_day)), by = c("year", "price_factor")) %>%
  gather(type, cv, count_cv, sum_cv, avg_cv)

# Run linear regressions to find corellation between the year and the spread of
# top auction days
models <- all_peaks %>%
  group_by(price_factor, type) %>%
  do(lms = lm(year ~ cv, data = .)) %>%
  tidy(lms) %>%
  filter(term == "cv") %>% 
  mutate(sig = p.value < 0.05) %>% 
  ungroup()

# Join the significance calculations back onto the top-N-days data, so that we
# can use ggplot to color each facet based on the value. Plot the change in
# distribution of these top days between 1780-1840, highlighting those with
# significant correlations
all_peaks %>%
  inner_join(models, by = c("price_factor", "type")) %>%
  mutate(
    type = factor(
      type,
      levels = c("avg_cv", "count_cv", "sum_cv"),
      labels = c( "Highest average price", "Highest number of sales", "Higest total revenue"))) %>%
  ggplot(aes(x = year, y = cv, color = estimate)) +
  geom_point(size = 3, alpha = 0.5) +
  geom_smooth(method = "lm") +
  facet_grid(type ~ price_factor) +
  theme_bw() +
  scale_color_gradient(low = "red", high = "black") +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  labs(
    x = "Year",
    y = paste0("Coefficient of variation of the top ", n_days, " days per year"),
    color = "Decrease in the CV of top sales days per year"
  )
```

```{r ra}

# Plot top N days against RA exhibition dates

# Join a table with the top N days together
top_Nth <- peak_n %>%
  left_join(peak_sum) %>%
  left_join(peak_avg) %>%
  gather(type, yday, count_day, sum_day, avg_day) %>%
  distinct() %>%
  # Join the Royal Academy exhibition dates, and calculate which ones take place
  # during the exhibition
  inner_join(ra_dates %>% select(year = exhib_year, exhib_start_day, exhib_end_day)) %>%
  mutate(during_exhib = yday >= exhib_start_day & yday <= exhib_end_day) %>%
  # Keep only selected quintiles, and re-label the type factor
  filter(price_factor == 5) %>%
  mutate(
    type = factor(
      type,
      levels = c("avg_day", "count_day", "sum_day"),
      labels = c( "Highest average price", "Highest number of sales", "Higest total revenue")))

# Calculate the ratio of top N days that take place during the RA exhibition,
# and join it to the table for plotting
num_during <- top_Nth %>%
  group_by(year, price_factor, type) %>%
  summarize(n = mean(during_exhib))
top_Nth <- top_Nth %>%
  inner_join(num_during)

ggplot(top_Nth, aes(x = year, y = yday)) +
  geom_point(size = 2, alpha = 0.5) +
  geom_ribbon(aes(ymin = exhib_start_day, ymax = exhib_end_day, na.rm = TRUE), alpha = 0.5) +
  geom_rug(aes(color = n), size = 2, sides = "b") +
  scale_color_gradient(low = "white", high = "red") +
  facet_wrap(~ type, nrow = 1) +
  theme_bw() +
  theme(
    legend.position = "bottom",
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  labs(
    x = "Year",
    y = "Day of the year",
    color = "Ratio of top auction days
    during RA exhibition",
    alpha = "Royal Exhibition open"
  ) +
  ylim(1, 365)
```
